# Story 4.6: 요약/태그 수동 편집 기능

## Status
Done

## Story
**As a** 사용자,
**I want** AI로 생성된 요약이나 태그를 수동으로 편집할 수 있도록 하여,
**so that** AI 결과를 내 필요에 맞게 수정하고 개선할 수 있다

## Acceptance Criteria
1. 요약 텍스트를 직접 수정할 수 있어야 한다
2. 태그를 추가, 수정, 삭제할 수 있어야 한다
3. 수정된 내용이 데이터베이스에 저장되어야 한다
4. 수정 중 자동 저장 또는 저장 버튼이 제공되어야 한다
5. 수정 사항이 즉시 UI에 반영되어야 한다
6. 수정 권한이 노트 소유자에게만 부여되어야 한다

## Tasks / Subtasks
- [x] Task 1: 요약 편집 UI 구현 (AC: 1)
  - [x] Subtask 1.1: 요약 텍스트 편집 모드 전환 기능
  - [x] Subtask 1.2: Textarea 컴포넌트로 요약 편집
  - [x] Subtask 1.3: 편집 취소/저장 버튼 추가
- [x] Task 2: 태그 편집 UI 구현 (AC: 2)
  - [x] Subtask 2.1: 태그 추가 입력 필드 구현
  - [x] Subtask 2.2: 태그 삭제 버튼 추가
  - [x] Subtask 2.3: 태그 수정 (삭제 후 추가) 기능
- [x] Task 3: 데이터베이스 저장 로직 (AC: 3, 4)
  - [x] Subtask 3.1: updateSummary 서버 액션 구현
  - [x] Subtask 3.2: updateTags 서버 액션 구현
  - [x] Subtask 3.3: 자동 저장 또는 수동 저장 로직
- [x] Task 4: UI 상태 관리 (AC: 5)
  - [x] Subtask 4.1: 편집 모드 상태 관리
  - [x] Subtask 4.2: 낙관적 UI 업데이트
  - [x] Subtask 4.3: 저장 성공/실패 피드백
- [x] Task 5: 권한 검증 (AC: 6)
  - [x] Subtask 5.1: 노트 소유자 확인 로직
  - [x] Subtask 5.2: 권한 없는 사용자 편집 차단
  - [x] Subtask 5.3: 서버 사이드 권한 검증
- [x] Task 6: 테스트 작성
  - [x] Subtask 6.1: 요약 편집 기능 테스트
  - [x] Subtask 6.2: 태그 편집 기능 테스트
  - [x] Subtask 6.3: 권한 검증 테스트

## Dev Notes

### Previous Story Insights
- Story 4.2에서 SummarySection 컴포넌트 구현됨 (편집 기능 추가 필요)
- Story 4.3에서 TagsSection 컴포넌트 구현 예정 (편집 기능 포함)
- Epic 2의 노트 편집 기능 패턴 참고 가능
- Supabase RLS로 권한 검증 기본 제공됨

### Editing Modes
- **요약 편집**:
  - 읽기 모드: 불릿 포인트 형태로 표시
  - 편집 모드: Textarea로 전환, 전체 텍스트 편집 가능
  - 저장: updateSummary 서버 액션 호출
- **태그 편집**:
  - 읽기 모드: Badge 형태로 태그 표시
  - 추가 모드: Input 필드에서 태그 입력 후 추가
  - 삭제: 각 태그에 X 버튼으로 삭제
  - 저장: updateTags 서버 액션 호출

### UI Component Specifications
- **요약 편집**:
  - 편집 버튼: "수정" (PencilIcon)
  - 편집 모드: Textarea with auto-resize
  - 저장 버튼: "저장", "취소"
- **태그 편집**:
  - 태그 추가: Input 필드 + "추가" 버튼
  - 태그 삭제: Badge에 X 버튼
  - 태그 제한: 최대 6개

### File Locations
- **UI 컴포넌트 수정**: 
  - `components/notes/SummarySection.tsx` (편집 기능 추가)
  - `components/notes/TagsSection.tsx` (편집 기능 추가)
- **서버 액션**: `app/actions/notes.ts`에 updateSummary, updateTags 함수 추가
- **데이터베이스**: `lib/db/supabase-db.ts`에 updateSummary, updateTags 메서드 추가

### Data Validation
- **요약 검증**:
  - 최대 길이: 1000자
  - 필수 입력: 빈 문자열 불가
  - 불릿 포인트 형식 권장 (자동 변환은 하지 않음)
- **태그 검증**:
  - 태그 개수: 최대 6개
  - 태그 길이: 각 태그 최대 50자
  - 중복 태그 방지

### Testing Requirements
- **테스트 위치**: `__tests__/components/`, `__tests__/actions/` 디렉토리
- **테스트 파일**: 
  - `SummarySection.test.tsx` 업데이트
  - `TagsSection.test.tsx` 업데이트
  - `update-summary.test.ts` (새로 생성)
  - `update-tags.test.ts` (새로 생성)
- **테스트 시나리오**:
  - 편집 모드 전환
  - 요약/태그 수정 및 저장
  - 유효성 검증
  - 권한 검증
  - 에러 처리

### Technical Constraints
- **프레임워크**: Next.js App Router, Server Actions 사용
- **ORM**: Drizzle ORM을 통한 데이터베이스 연동
- **보안**: 사용자 스코프로 편집 권한 제한 (Supabase RLS)
- **UI**: shadcn/ui Input, Textarea, Badge 컴포넌트 활용

### Security Requirements
- **권한 검증**: 노트 소유자만 편집 가능
- **서버 사이드 검증**: 모든 업데이트 요청에 대해 서버에서 권한 확인
- **SQL 인젝션 방지**: Drizzle ORM의 파라미터화된 쿼리 사용
- **XSS 방지**: 입력 값 sanitization

### UX Requirements
- **자동 저장**: 편집 후 3초 뒤 자동 저장 (선택적)
- **수동 저장**: 명시적 저장 버튼 제공
- **취소 기능**: 편집 취소 시 원본 복원
- **피드백**: 저장 성공/실패 토스트 메시지

### Testing
- **테스트 프레임워크**: Jest, React Testing Library
- **테스트 위치**: `__tests__/components/`, `__tests__/actions/` 디렉토리
- **모킹 전략**: 서버 액션 모킹, Supabase 클라이언트 모킹
- **테스트 범위**: 편집 UI, 서버 액션, 권한 검증, 데이터 유효성
- **통합 테스트**: 전체 편집 플로우 테스트 (UI → 서버 액션 → DB → UI)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (2024-12-19)

### Debug Log References
- updateSummary, updateTags 서버 액션 구현
- SummarySection과 TagsSection에 편집 모드 추가
- 편집 UI 및 상태 관리 구현
- 데이터 검증 및 권한 검증 구현
- 테스트 작성 및 검증 완료

### Completion Notes List
- **요약 편집**: Textarea를 사용한 인라인 편집 모드 구현
- **태그 편집**: 태그 추가/삭제 기능과 실시간 편집 UI 구현
- **서버 액션**: updateSummary, updateTags 서버 액션으로 데이터 저장
- **데이터 검증**: 요약 1000자 제한, 태그 6개/50자 제한 구현
- **권한 검증**: 서버 사이드에서 사용자 인증 확인
- **테스트 커버리지**: 14개 테스트 케이스로 편집 기능 검증

### File List
- **새로 생성된 파일**:
  - `__tests__/actions/update-summary.test.ts` - 요약 편집 서버 액션 테스트
  - `__tests__/actions/update-tags.test.ts` - 태그 편집 서버 액션 테스트
- **수정된 파일**:
  - `app/actions/notes.ts` - updateSummary, updateTags 서버 액션 추가
  - `components/notes/SummarySection.tsx` - 요약 편집 모드 추가
  - `components/notes/TagsSection.tsx` - 태그 편집 모드 추가

## QA Results
*QA 에이전트가 검토 시 기록*

