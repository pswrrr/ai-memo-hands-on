# Story 1.2: 이메일/비밀번호 로그인

## 📋 Status
**Done**

## 🎯 Story

**As a** 등록된 사용자  
**I want** 이메일과 비밀번호로 로그인할 수 있도록  
**So that** AI 메모장에 접근하여 내 메모를 관리할 수 있다

## 📊 Acceptance Criteria

### 기능 요구사항
1. 이메일 주소 입력 필드 제공
2. 비밀번호 입력 필드 제공
3. 로그인 버튼 클릭 시 유효성 검사 수행
4. 유효하지 않은 입력에 대한 에러 메시지 표시
5. 로그인 성공 시 메인 대시보드로 리다이렉트
6. 잘못된 이메일 또는 비밀번호 입력 시 명확한 에러 메시지 제공
7. "비밀번호 찾기" 링크 제공 (Story 1.3 참조)
8. "회원가입" 링크 제공

### UI/UX 요구사항
1. 깔끔하고 직관적인 로그인 폼 디자인
2. 실시간 입력 유효성 검사 피드백
3. 로딩 상태 표시 (로그인 처리 중)
4. 성공/실패 상태에 따른 적절한 피드백
5. 비밀번호 표시/숨기기 토글 기능

### 기술적 요구사항
1. Supabase Auth API 연동 (`signInWithPassword`)
2. Next.js App Router 기반 구현
3. 클라이언트 사이드 유효성 검사
4. 서버 사이드 보안 검증
5. 에러 핸들링 및 로깅
6. 세션 관리 및 자동 갱신

## 📝 Tasks / Subtasks

- [x] Task 1: 로그인 페이지 라우트 설정 (AC: 1, 2, 8)
  - [x] `/app/auth/login/page.tsx` 생성
  - [x] 인증 레이아웃 재사용 (`/app/auth/layout.tsx`)
  - [x] 회원가입 링크 추가

- [x] Task 2: 로그인 폼 컴포넌트 구현 (AC: 1-6)
  - [x] `components/auth/LoginForm.tsx` 생성
  - [x] 이메일 입력 필드 구현
  - [x] 비밀번호 입력 필드 구현
  - [x] 비밀번호 표시/숨기기 토글 구현
  - [x] 로그인 버튼 구현
  - [x] 실시간 유효성 검사 적용
  - [x] 로딩 상태 관리

- [x] Task 3: Supabase Auth 로그인 함수 구현 (AC: 5, 6)
  - [x] `lib/auth.ts`에 `signIn` 함수 확인/업데이트
  - [x] 에러 메시지 매핑 추가
  - [x] 세션 처리 로직 구현

- [x] Task 4: 폼 유효성 검사 로직 구현 (AC: 3, 4)
  - [x] `lib/validations.ts`에 로그인 폼 스키마 추가
  - [x] 이메일 형식 검증
  - [x] 필수 필드 검증

- [x] Task 5: 에러 처리 및 사용자 피드백 (AC: 4, 6)
  - [x] 잘못된 이메일/비밀번호 에러 처리
  - [x] 네트워크 에러 처리
  - [x] 사용자 친화적 에러 메시지 표시
  - [x] 성공 메시지 표시

- [x] Task 6: 리다이렉션 로직 구현 (AC: 5)
  - [x] 로그인 성공 시 대시보드로 리다이렉트
  - [x] 이전 페이지로 리다이렉트 (옵션)

- [x] Task 7: 비밀번호 찾기 링크 추가 (AC: 7)
  - [x] Story 1.3 준비를 위한 링크 구현

- [ ] Task 8: 단위 테스트 작성 (선택사항 - Story 1.5에서 통합)
  - [ ] 로그인 폼 검증 테스트
  - [ ] Supabase Auth 연동 테스트
  - [ ] 에러 처리 테스트
  - [ ] 리다이렉션 테스트

## 🔧 Dev Notes

### Previous Story Insights
Story 1.1에서 구현된 사항:
- Supabase Auth 클라이언트 설정 완료 (`lib/auth.ts`, `lib/supabase.ts`)
- 이메일 유효성 검사 로직 구현 (`lib/validations.ts`)
- 인증 레이아웃 컴포넌트 구현 (`app/auth/layout.tsx`)
- 인증 공통 레이아웃 컴포넌트 (`components/auth/AuthLayout.tsx`)
- 에러 메시지 매핑 함수 구현 (`getAuthErrorMessage`)
- 100% 코드 커버리지 단위 테스트 구현

재사용 가능한 컴포넌트 및 함수:
- `components/auth/AuthLayout.tsx` - 인증 페이지 공통 레이아웃
- `lib/validations.ts` - 이메일 검증 함수 (`validateEmail`)
- `lib/auth.ts` - Supabase Auth 유틸리티 함수들
- `app/auth/layout.tsx` - 인증 라우트 레이아웃

### Architecture Context

**기술 스택** [Source: docs/architecture.md#1]
- Next.js App Router - 서버 컴포넌트 및 Server Actions 활용
- Supabase Auth - 이메일/비밀번호 인증
- shadcn/ui + Tailwind CSS - UI 컴포넌트
- TypeScript - 타입 안전성

**인증 플로우** [Source: docs/architecture.md#3]
- Supabase Auth의 `signInWithPassword` 메서드 사용
- 세션 관리 및 자동 갱신 필요
- 서버 사이드 보안 검증 필수

**보안 고려사항** [Source: docs/architecture.md#3]
- 클라이언트와 서버 양측에서 유효성 검사
- Supabase 서비스 롤 키는 서버 전용으로만 사용
- RLS(Row Level Security) 정책 준수

### File Structure
```
app/
└── auth/
    ├── login/
    │   └── page.tsx              # 새로 생성: 로그인 페이지
    ├── layout.tsx                # 재사용: 인증 레이아웃
    └── signup/
        └── page.tsx              # 기존: 회원가입 페이지

components/
└── auth/
    ├── AuthLayout.tsx            # 재사용: 공통 인증 레이아웃
    ├── LoginForm.tsx             # 새로 생성: 로그인 폼
    └── SignupForm.tsx            # 기존: 회원가입 폼

lib/
├── auth.ts                       # 업데이트: signIn 함수 확인/추가
├── supabase.ts                   # 재사용: Supabase 클라이언트
└── validations.ts                # 업데이트: 로그인 폼 스키마 추가
```

### Data Models
- **User Authentication** [Source: docs/architecture.md#2]
  - Supabase Auth의 `auth.users` 테이블 사용
  - 이메일과 비밀번호로 인증
  - 세션 토큰 자동 관리

### API Specifications
- **Supabase Auth API**
  - `supabase.auth.signInWithPassword({ email, password })`
  - 성공 시 user 객체와 session 반환
  - 실패 시 error 객체 반환

### Testing Requirements
**테스트 파일 위치**: `__tests__/`
- `__tests__/validations.test.ts` - 유효성 검사 테스트 (기존 파일 확장)
- `__tests__/login.test.ts` - 로그인 기능 테스트 (새로 생성)

**테스트 프레임워크**: Jest + Testing Library
- 로그인 폼 렌더링 테스트
- 유효성 검사 테스트
- Supabase Auth 연동 모킹 테스트
- 에러 처리 테스트
- 리다이렉션 테스트

**테스트 커버리지 목표**: 100% (Statements, Branches, Functions, Lines)

### Technical Constraints
- 비밀번호는 Supabase에서 최소 6자 이상 요구 (Story 1.1에서는 8자로 강화)
- 이메일은 RFC 5322 표준 준수
- 로그인 시도 제한은 Supabase Auth에서 자동 처리
- 세션 토큰은 httpOnly 쿠키로 자동 저장

### Implementation Notes
1. Story 1.1에서 구현된 `lib/auth.ts`의 `signIn` 함수가 이미 존재하므로, 해당 함수를 활용
2. `lib/validations.ts`에 로그인 폼 스키마 추가 필요
3. `components/auth/LoginForm.tsx`는 `SignupForm.tsx`와 유사한 구조로 구현
4. 비밀번호 표시/숨기기 토글은 `shadcn/ui`의 Icon 컴포넌트 활용
5. 로그인 성공 시 Next.js의 `useRouter`로 `/dashboard` 또는 `/` 로 리다이렉트

## 📅 Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Story 1.2 초안 생성 | Bob (Scrum Master) |

## 🔄 Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- 로그인 페이지 및 폼 컴포넌트 구현 완료
- Story 1.1에서 구현된 `signIn` 함수 재사용
- 비밀번호 표시/숨기기 토글 기능 추가 (lucide-react 아이콘 사용)
- 실시간 유효성 검사 및 에러 처리 구현
- 로그인 성공 시 성공 메시지 표시 및 자동 리다이렉트
- 비밀번호 찾기 및 회원가입 링크 추가
- **중요 버그 수정**: `lib/supabase.ts`를 `createBrowserClient`로 변경하여 쿠키 기반 세션 관리 구현
- `window.location.href`를 사용한 강제 페이지 새로고침으로 서버 컴포넌트 세션 동기화
- 상세 디버깅 로그 추가하여 세션 문제 진단 및 해결

### File List
**Created:**
- `app/auth/login/page.tsx` - 로그인 페이지
- `components/auth/LoginForm.tsx` - 로그인 폼 컴포넌트

**Modified:**
- `lib/validations.ts` - LoginFormData 인터페이스 및 validateLoginForm 함수 추가
- `lib/supabase.ts` - `createClient`에서 `createBrowserClient`로 변경 (쿠키 기반 세션 관리)
- `lib/auth.ts` - signIn 함수에 상세 디버깅 로그 추가
- `components/auth/SignupForm.tsx` - 리다이렉트 로직을 `window.location.href`로 변경

**Reused:**
- `lib/auth.ts` - signIn 함수 (Story 1.1에서 구현됨)
- `components/auth/AuthLayout.tsx` - 인증 레이아웃 (Story 1.1에서 구현됨)
- `app/auth/layout.tsx` - 인증 라우트 레이아웃 (Story 1.1에서 구현됨)

## ✅ QA Results
_To be filled by QA Agent_

