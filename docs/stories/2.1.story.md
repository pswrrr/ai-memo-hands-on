# Story 2.1: DrizzleORM í™˜ê²½ ì„¤ì •

## ğŸ“‹ Status
**Done**

## ğŸ¯ Story

**As a** ê°œë°œì  
**I want** DrizzleORMì´ í”„ë¡œì íŠ¸ì— ì„¤ì •ë˜ì–´  
**So that** ë…¸íŠ¸ ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤

## ğŸ“Š Acceptance Criteria

### ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­
1. DrizzleORM íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ì„¤ì •
2. PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •
3. ë…¸íŠ¸ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜
4. Drizzle Studio ê°œë°œ ë„êµ¬ ì„¤ì •
5. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ êµ¬ì„±
6. íƒ€ì… ì•ˆì „ì„± ë³´ì¥

### ê¸°ìˆ ì  ìš”êµ¬ì‚¬í•­
1. DrizzleORM + PostgreSQL ë“œë¼ì´ë²„ ì„¤ì¹˜
2. í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
3. ìŠ¤í‚¤ë§ˆ íŒŒì¼ êµ¬ì¡°í™” (tables, relations)
4. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìë™ ìƒì„±
5. TypeScript íƒ€ì… ìƒì„±
6. ê°œë°œ í™˜ê²½ Drizzle Studio ì„¤ì •

### ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­
1. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í’€ ì„¤ì •
2. ì¿¼ë¦¬ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤ ì„¤ê³„
3. íŠ¸ëœì­ì…˜ ì§€ì›
4. ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§

## ğŸ“ Tasks / Subtasks

- [x] Task 1: DrizzleORM íŒ¨í‚¤ì§€ ì„¤ì¹˜
  - [x] `drizzle-orm` íŒ¨í‚¤ì§€ ì„¤ì¹˜
  - [x] `postgres` ë“œë¼ì´ë²„ ì„¤ì¹˜
  - [x] `drizzle-kit` ê°œë°œ ë„êµ¬ ì„¤ì¹˜
  - [x] `@types/pg` íƒ€ì… ì •ì˜ ì„¤ì¹˜

- [x] Task 2: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •
  - [x] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (.env.local)
  - [x] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ìì—´ êµ¬ì„±
  - [x] ì—°ê²° í’€ ì„¤ì •
  - [x] ì—°ê²° í…ŒìŠ¤íŠ¸

- [x] Task 3: ìŠ¤í‚¤ë§ˆ ì •ì˜
  - [x] `lib/db/schema.ts` ìƒì„±
  - [x] ë…¸íŠ¸ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜
  - [x] ì‚¬ìš©ì-ë…¸íŠ¸ ê´€ê³„ ì •ì˜
  - [x] ì¸ë±ìŠ¤ ì„¤ì •

- [x] Task 4: ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
  - [x] `lib/db/index.ts` ìƒì„±
  - [x] Drizzle í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  - [x] ì—°ê²° ìƒíƒœ ê´€ë¦¬
  - [x] ì—ëŸ¬ í•¸ë“¤ë§

- [x] Task 5: ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ ì„¤ì •
  - [x] `drizzle.config.ts` ì„¤ì • íŒŒì¼ ìƒì„±
  - [x] ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
  - [x] ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
  - [x] ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸

- [x] Task 6: Drizzle Studio ì„¤ì •
  - [x] ê°œë°œ í™˜ê²½ Studio ì„¤ì •
  - [x] ë°ì´í„°ë² ì´ìŠ¤ ë¸Œë¼ìš°ì € êµ¬ì„±
  - [x] ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ í™˜ê²½

- [x] Task 7: íƒ€ì… ìƒì„± ë° ê²€ì¦
  - [x] TypeScript íƒ€ì… ìë™ ìƒì„±
  - [x] íƒ€ì… ì•ˆì „ì„± ê²€ì¦
  - [x] ìŠ¤í‚¤ë§ˆ ë³€ê²½ ê°ì§€

- [x] Task 8: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
  - [x] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
  - [x] ìŠ¤í‚¤ë§ˆ ê²€ì¦ í…ŒìŠ¤íŠ¸
  - [x] ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸

## ğŸ”§ Dev Notes

### Previous Story Insights
Story 1.1-1.6ì—ì„œ êµ¬í˜„ëœ ì‚¬í•­:
- Supabase Auth ì‹œìŠ¤í…œ ì™„ë£Œ (ì¸ì¦, ì„¸ì…˜ ê´€ë¦¬, ì˜¨ë³´ë”©)
- ì‚¬ìš©ì ì¸ì¦ ë° ì„¸ì…˜ ê´€ë¦¬ ì™„ë£Œ
- ë³´í˜¸ëœ ë¼ìš°íŠ¸ ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„
- ì „ì—­ ìƒíƒœ ê´€ë¦¬ (AuthContext) êµ¬í˜„

ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì»´í¬ë„ŒíŠ¸ ë° í•¨ìˆ˜:
- `lib/supabase.ts` - Supabase í´ë¼ì´ì–¸íŠ¸
- `lib/supabase-server.ts` - ì„œë²„ ì‚¬ì´ë“œ í´ë¼ì´ì–¸íŠ¸
- `contexts/AuthContext.tsx` - ì¸ì¦ ìƒíƒœ ê´€ë¦¬
- `hooks/useAuth.ts` - ì¸ì¦ í›…
- í™˜ê²½ ë³€ìˆ˜ ì„¤ì • íŒ¨í„´

### Architecture Context

**ê¸°ìˆ  ìŠ¤íƒ** [Source: docs/architecture.md#1]
- Next.js (App Router, Server Actions)
- Drizzle ORM (ë§ˆì´ê·¸ë ˆì´ì…˜/ì¿¼ë¦¬)
- Supabase (Postgres, Auth, Storage)
- TypeScript - íƒ€ì… ì•ˆì „ì„±

**ë°ì´í„° ëª¨ë¸ë§** [Source: docs/architecture.md#2]
- notes í…Œì´ë¸”: id, user_id, title, content, created_at, updated_at
- note_tags í…Œì´ë¸”: note_id, tag
- summaries í…Œì´ë¸”: note_id, model, content, created_at
- ì‚¬ìš©ì-ë…¸íŠ¸ 1:N ê´€ê³„
- Postgres Full Text Search ì§€ì›

**ë³´ì•ˆ ê³ ë ¤ì‚¬í•­** [Source: docs/architecture.md#3]
- ê¶Œí•œ ìŠ¤ì½”í”„: Notes/TagsëŠ” ì‚¬ìš©ì ID ìŠ¤ì½”í”„ë¡œ ì†Œìœ ìë§Œ CRUD ê°€ëŠ¥
- Supabase ì„œë¹„ìŠ¤ ë¡¤ í‚¤ëŠ” ì„œë²„ ì „ìš©
- RLS (Row Level Security) ì •ì±… ì ìš©

**ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­** [Source: docs/architecture.md#5]
- Postgres Full Text Search (íƒœê·¸ > ì œëª© > ë³¸ë¬¸)
- GIN ì¸ë±ìŠ¤ ê¸°ë°˜ ìµœì í™”
- Drizzle Kitìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬

### File Structure
```
lib/
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ index.ts              # ìƒˆë¡œ ìƒì„±: Drizzle í´ë¼ì´ì–¸íŠ¸
â”‚   â”œâ”€â”€ schema.ts             # ìƒˆë¡œ ìƒì„±: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
â”‚   â””â”€â”€ migrations/           # ìƒˆë¡œ ìƒì„±: ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë“¤
â”‚       â””â”€â”€ 0001_initial.sql

drizzle.config.ts             # ìƒˆë¡œ ìƒì„±: Drizzle ì„¤ì •
.env.local                    # ìˆ˜ì •: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ ì¶”ê°€

package.json                  # ìˆ˜ì •: DrizzleORM ì˜ì¡´ì„± ì¶”ê°€
```

### Database Schema
```sql
-- notes í…Œì´ë¸” (Supabase Auth users í…Œì´ë¸”ê³¼ ì—°ë™)
CREATE TABLE notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  content TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- note_tags í…Œì´ë¸”
CREATE TABLE note_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  note_id UUID NOT NULL REFERENCES notes(id) ON DELETE CASCADE,
  tag VARCHAR(100) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- summaries í…Œì´ë¸”
CREATE TABLE summaries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  note_id UUID NOT NULL REFERENCES notes(id) ON DELETE CASCADE,
  model VARCHAR(50) NOT NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ (Full Text Search ìµœì í™”)
CREATE INDEX idx_notes_user_id ON notes(user_id);
CREATE INDEX idx_notes_created_at ON notes(created_at);
CREATE INDEX idx_note_tags_note_id ON note_tags(note_id);
CREATE INDEX idx_note_tags_tag ON note_tags(tag);
CREATE INDEX idx_summaries_note_id ON summaries(note_id);

-- Full Text Search ì¸ë±ìŠ¤
CREATE INDEX idx_notes_content_fts ON notes USING gin(to_tsvector('korean', content));
CREATE INDEX idx_notes_title_fts ON notes USING gin(to_tsvector('korean', title));
```

### API Specifications
- **DrizzleORM í´ë¼ì´ì–¸íŠ¸**
  - `db.select()` - ë°ì´í„° ì¡°íšŒ
  - `db.insert()` - ë°ì´í„° ì‚½ì…
  - `db.update()` - ë°ì´í„° ìˆ˜ì •
  - `db.delete()` - ë°ì´í„° ì‚­ì œ

- **ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬**
  - `drizzle-kit generate` - ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
  - `drizzle-kit migrate` - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
  - `drizzle-kit studio` - ê°œë°œ ë„êµ¬ ì‹¤í–‰

### Testing Requirements
**í…ŒìŠ¤íŠ¸ íŒŒì¼ ìœ„ì¹˜**: `__tests__/`
- `__tests__/db-connection.test.ts` - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ (ìƒˆë¡œ ìƒì„±)
- `__tests__/schema.test.ts` - ìŠ¤í‚¤ë§ˆ ê²€ì¦ í…ŒìŠ¤íŠ¸ (ìƒˆë¡œ ìƒì„±)

**í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬**: Jest + Testing Library
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
- ìŠ¤í‚¤ë§ˆ ì •ì˜ ê²€ì¦
- ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
- íƒ€ì… ì•ˆì „ì„± í…ŒìŠ¤íŠ¸

**í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ëª©í‘œ**: 100% (Statements, Branches, Functions, Lines)

### Technical Constraints
- PostgreSQL 15+ ë²„ì „ í•„ìš”
- í™˜ê²½ ë³€ìˆ˜ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ ê´€ë¦¬
- ë§ˆì´ê·¸ë ˆì´ì…˜ì€ í•­ìƒ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
- ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ íƒ€ì… ì¬ìƒì„± í•„ìˆ˜

### Implementation Notes
1. DrizzleORMì˜ íƒ€ì… ì•ˆì „ì„± í™œìš©
2. PostgreSQLì˜ UUID íƒ€ì… ì‚¬ìš©
3. ì†Œí”„íŠ¸ ì‚­ì œë¥¼ ìœ„í•œ deleted_at ì»¬ëŸ¼
4. ìë™ íƒ€ì„ìŠ¤íƒ¬í”„ ê´€ë¦¬
5. ê°œë°œ í™˜ê²½ì—ì„œ Drizzle Studio í™œìš©

## ğŸ“… Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story 2.1 ì´ˆì•ˆ ìƒì„± | Sarah (Product Owner) |
| 2025-01-27 | 1.1 | Story 2.1 êµ¬í˜„ ì™„ë£Œ | James (Full Stack Developer) |

## ğŸ”„ Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- DrizzleORM íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ (drizzle-orm, postgres, drizzle-kit, @types/pg)
- í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ (.env.localì— DATABASE_URL ì¶”ê°€)
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì •ì˜ ì™„ë£Œ (notes, note_tags, summaries, auth.users í…Œì´ë¸”)
- Drizzle í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ì™„ë£Œ (ì—°ê²° í’€, ì—ëŸ¬ í•¸ë“¤ë§ í¬í•¨)
- ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ ì„¤ì • ì™„ë£Œ (drizzle.config.ts, package.json ìŠ¤í¬ë¦½íŠ¸)
- Jest í™˜ê²½ ì„¤ì • ê°œì„  (setImmediate/clearImmediate í´ë¦¬í•„)
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ì™„ë£Œ (ìŠ¤í‚¤ë§ˆ ê²€ì¦, ì—°ê²° í…ŒìŠ¤íŠ¸)
- ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ (5/5 í…ŒìŠ¤íŠ¸ ì„±ê³µ)

### File List
**ìƒˆë¡œ ìƒì„±ëœ íŒŒì¼:**
- `lib/db/schema.ts` - ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì •ì˜
- `lib/db/index.ts` - Drizzle í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
- `drizzle.config.ts` - Drizzle Kit ì„¤ì •
- `jest.env.js` - Jest í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- `__tests__/db-connection.test.ts` - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
- `__tests__/schema.test.ts` - ìŠ¤í‚¤ë§ˆ ê²€ì¦ í…ŒìŠ¤íŠ¸
- `lib/db/migrations/0000_marvelous_outlaw_kid.sql` - ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜

**ìˆ˜ì •ëœ íŒŒì¼:**
- `package.json` - DrizzleORM ì˜ì¡´ì„± ë° ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
- `.env.local` - DATABASE_URL í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
- `jest.config.js` - í™˜ê²½ ë³€ìˆ˜ ë¡œë”© ì„¤ì • ì¶”ê°€
- `jest.setup.js` - setImmediate/clearImmediate í´ë¦¬í•„ ì¶”ê°€

## âœ… QA Results
_To be filled by QA Agent_
