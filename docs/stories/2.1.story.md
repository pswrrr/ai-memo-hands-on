# Story 2.1: DrizzleORM 환경 설정

## 📋 Status
**Done**

## 🎯 Story

**As a** 개발자  
**I want** DrizzleORM이 프로젝트에 설정되어  
**So that** 노트 데이터를 효율적으로 관리할 수 있다

## 📊 Acceptance Criteria

### 기능 요구사항
1. DrizzleORM 패키지 설치 및 설정
2. PostgreSQL 데이터베이스 연결 설정
3. 노트 테이블 스키마 정의
4. Drizzle Studio 개발 도구 설정
5. 마이그레이션 시스템 구성
6. 타입 안전성 보장

### 기술적 요구사항
1. DrizzleORM + PostgreSQL 드라이버 설치
2. 환경 변수를 통한 데이터베이스 연결
3. 스키마 파일 구조화 (tables, relations)
4. 마이그레이션 파일 자동 생성
5. TypeScript 타입 생성
6. 개발 환경 Drizzle Studio 설정

### 성능 요구사항
1. 데이터베이스 연결 풀 설정
2. 쿼리 최적화를 위한 인덱스 설계
3. 트랜잭션 지원
4. 연결 상태 모니터링

## 📝 Tasks / Subtasks

- [x] Task 1: DrizzleORM 패키지 설치
  - [x] `drizzle-orm` 패키지 설치
  - [x] `postgres` 드라이버 설치
  - [x] `drizzle-kit` 개발 도구 설치
  - [x] `@types/pg` 타입 정의 설치

- [x] Task 2: 데이터베이스 연결 설정
  - [x] 환경 변수 설정 (.env.local)
  - [x] 데이터베이스 연결 문자열 구성
  - [x] 연결 풀 설정
  - [x] 연결 테스트

- [x] Task 3: 스키마 정의
  - [x] `lib/db/schema.ts` 생성
  - [x] 노트 테이블 스키마 정의
  - [x] 사용자-노트 관계 정의
  - [x] 인덱스 설정

- [x] Task 4: 데이터베이스 클라이언트 설정
  - [x] `lib/db/index.ts` 생성
  - [x] Drizzle 클라이언트 인스턴스 생성
  - [x] 연결 상태 관리
  - [x] 에러 핸들링

- [x] Task 5: 마이그레이션 시스템 설정
  - [x] `drizzle.config.ts` 설정 파일 생성
  - [x] 마이그레이션 스크립트 작성
  - [x] 초기 마이그레이션 생성
  - [x] 마이그레이션 실행 스크립트

- [x] Task 6: Drizzle Studio 설정
  - [x] 개발 환경 Studio 설정
  - [x] 데이터베이스 브라우저 구성
  - [x] 쿼리 테스트 환경

- [x] Task 7: 타입 생성 및 검증
  - [x] TypeScript 타입 자동 생성
  - [x] 타입 안전성 검증
  - [x] 스키마 변경 감지

- [x] Task 8: 단위 테스트 작성
  - [x] 데이터베이스 연결 테스트
  - [x] 스키마 검증 테스트
  - [x] 마이그레이션 테스트

## 🔧 Dev Notes

### Previous Story Insights
Story 1.1-1.6에서 구현된 사항:
- Supabase Auth 시스템 완료 (인증, 세션 관리, 온보딩)
- 사용자 인증 및 세션 관리 완료
- 보호된 라우트 미들웨어 구현
- 전역 상태 관리 (AuthContext) 구현

재사용 가능한 컴포넌트 및 함수:
- `lib/supabase.ts` - Supabase 클라이언트
- `lib/supabase-server.ts` - 서버 사이드 클라이언트
- `contexts/AuthContext.tsx` - 인증 상태 관리
- `hooks/useAuth.ts` - 인증 훅
- 환경 변수 설정 패턴

### Architecture Context

**기술 스택** [Source: docs/architecture.md#1]
- Next.js (App Router, Server Actions)
- Drizzle ORM (마이그레이션/쿼리)
- Supabase (Postgres, Auth, Storage)
- TypeScript - 타입 안전성

**데이터 모델링** [Source: docs/architecture.md#2]
- notes 테이블: id, user_id, title, content, created_at, updated_at
- note_tags 테이블: note_id, tag
- summaries 테이블: note_id, model, content, created_at
- 사용자-노트 1:N 관계
- Postgres Full Text Search 지원

**보안 고려사항** [Source: docs/architecture.md#3]
- 권한 스코프: Notes/Tags는 사용자 ID 스코프로 소유자만 CRUD 가능
- Supabase 서비스 롤 키는 서버 전용
- RLS (Row Level Security) 정책 적용

**성능 고려사항** [Source: docs/architecture.md#5]
- Postgres Full Text Search (태그 > 제목 > 본문)
- GIN 인덱스 기반 최적화
- Drizzle Kit으로 마이그레이션 관리

### File Structure
```
lib/
├── db/
│   ├── index.ts              # 새로 생성: Drizzle 클라이언트
│   ├── schema.ts             # 새로 생성: 데이터베이스 스키마
│   └── migrations/           # 새로 생성: 마이그레이션 파일들
│       └── 0001_initial.sql

drizzle.config.ts             # 새로 생성: Drizzle 설정
.env.local                    # 수정: 데이터베이스 연결 정보 추가

package.json                  # 수정: DrizzleORM 의존성 추가
```

### Database Schema
```sql
-- notes 테이블 (Supabase Auth users 테이블과 연동)
CREATE TABLE notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  content TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- note_tags 테이블
CREATE TABLE note_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  note_id UUID NOT NULL REFERENCES notes(id) ON DELETE CASCADE,
  tag VARCHAR(100) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- summaries 테이블
CREATE TABLE summaries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  note_id UUID NOT NULL REFERENCES notes(id) ON DELETE CASCADE,
  model VARCHAR(50) NOT NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 인덱스 (Full Text Search 최적화)
CREATE INDEX idx_notes_user_id ON notes(user_id);
CREATE INDEX idx_notes_created_at ON notes(created_at);
CREATE INDEX idx_note_tags_note_id ON note_tags(note_id);
CREATE INDEX idx_note_tags_tag ON note_tags(tag);
CREATE INDEX idx_summaries_note_id ON summaries(note_id);

-- Full Text Search 인덱스
CREATE INDEX idx_notes_content_fts ON notes USING gin(to_tsvector('korean', content));
CREATE INDEX idx_notes_title_fts ON notes USING gin(to_tsvector('korean', title));
```

### API Specifications
- **DrizzleORM 클라이언트**
  - `db.select()` - 데이터 조회
  - `db.insert()` - 데이터 삽입
  - `db.update()` - 데이터 수정
  - `db.delete()` - 데이터 삭제

- **마이그레이션 관리**
  - `drizzle-kit generate` - 마이그레이션 생성
  - `drizzle-kit migrate` - 마이그레이션 실행
  - `drizzle-kit studio` - 개발 도구 실행

### Testing Requirements
**테스트 파일 위치**: `__tests__/`
- `__tests__/db-connection.test.ts` - 데이터베이스 연결 테스트 (새로 생성)
- `__tests__/schema.test.ts` - 스키마 검증 테스트 (새로 생성)

**테스트 프레임워크**: Jest + Testing Library
- 데이터베이스 연결 테스트
- 스키마 정의 검증
- 마이그레이션 테스트
- 타입 안전성 테스트

**테스트 커버리지 목표**: 100% (Statements, Branches, Functions, Lines)

### Technical Constraints
- PostgreSQL 15+ 버전 필요
- 환경 변수로 데이터베이스 연결 정보 관리
- 마이그레이션은 항상 순차적으로 실행
- 스키마 변경 시 타입 재생성 필수

### Implementation Notes
1. DrizzleORM의 타입 안전성 활용
2. PostgreSQL의 UUID 타입 사용
3. 소프트 삭제를 위한 deleted_at 컬럼
4. 자동 타임스탬프 관리
5. 개발 환경에서 Drizzle Studio 활용

## 📅 Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story 2.1 초안 생성 | Sarah (Product Owner) |
| 2025-01-27 | 1.1 | Story 2.1 구현 완료 | James (Full Stack Developer) |

## 🔄 Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- DrizzleORM 패키지 설치 완료 (drizzle-orm, postgres, drizzle-kit, @types/pg)
- 환경 변수 설정 완료 (.env.local에 DATABASE_URL 추가)
- 데이터베이스 스키마 정의 완료 (notes, note_tags, summaries, auth.users 테이블)
- Drizzle 클라이언트 설정 완료 (연결 풀, 에러 핸들링 포함)
- 마이그레이션 시스템 설정 완료 (drizzle.config.ts, package.json 스크립트)
- Jest 환경 설정 개선 (setImmediate/clearImmediate 폴리필)
- 단위 테스트 작성 완료 (스키마 검증, 연결 테스트)
- 모든 테스트 통과 (5/5 테스트 성공)

### File List
**새로 생성된 파일:**
- `lib/db/schema.ts` - 데이터베이스 스키마 정의
- `lib/db/index.ts` - Drizzle 클라이언트 설정
- `drizzle.config.ts` - Drizzle Kit 설정
- `jest.env.js` - Jest 환경 변수 설정
- `__tests__/db-connection.test.ts` - 데이터베이스 연결 테스트
- `__tests__/schema.test.ts` - 스키마 검증 테스트
- `lib/db/migrations/0000_marvelous_outlaw_kid.sql` - 초기 마이그레이션

**수정된 파일:**
- `package.json` - DrizzleORM 의존성 및 스크립트 추가
- `.env.local` - DATABASE_URL 환경 변수 추가
- `jest.config.js` - 환경 변수 로딩 설정 추가
- `jest.setup.js` - setImmediate/clearImmediate 폴리필 추가

## ✅ QA Results
_To be filled by QA Agent_
