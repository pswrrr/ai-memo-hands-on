# Story 1.3: 비밀번호 재설정

## 📋 Status
**Done**

## 🎯 Story

**As a** 비밀번호를 잊어버린 사용자  
**I want** 이메일을 통해 비밀번호를 재설정할 수 있도록  
**So that** 계정에 다시 접근할 수 있다

## 📊 Acceptance Criteria

### 기능 요구사항
1. 비밀번호 재설정 요청 페이지 제공
2. 이메일 주소 입력 필드 제공
3. "재설정 링크 전송" 버튼 클릭 시 이메일로 링크 전송
4. 이메일 전송 성공 메시지 표시
5. 재설정 링크 클릭 시 새 비밀번호 입력 페이지로 이동
6. 새 비밀번호 및 비밀번호 확인 입력 필드 제공
7. 비밀번호 변경 성공 시 로그인 페이지로 리다이렉트
8. 유효하지 않거나 만료된 링크에 대한 에러 처리

### UI/UX 요구사항
1. 깔끔하고 직관적한 비밀번호 재설정 폼 디자인
2. 실시간 입력 유효성 검사 피드백
3. 로딩 상태 표시 (이메일 전송 중)
4. 성공/실패 상태에 따른 적절한 피드백
5. 로그인 페이지로 돌아가기 링크 제공

### 기술적 요구사항
1. Supabase Auth API 연동 (`resetPasswordForEmail`, `updateUser`)
2. Next.js App Router 기반 구현
3. 이메일 템플릿 설정 (Supabase Dashboard)
4. 클라이언트 사이드 유효성 검사
5. 링크 만료 시간 처리 (기본 1시간)
6. 에러 핸들링 및 로깅

## 📝 Tasks / Subtasks

- [x] Task 1: 비밀번호 재설정 요청 페이지 라우트 설정 (AC: 1, 2, 5)
  - [x] `/app/auth/reset-password/page.tsx` 생성
  - [x] 인증 레이아웃 재사용
  - [x] 로그인 페이지로 돌아가기 링크 추가

- [x] Task 2: 비밀번호 재설정 요청 폼 구현 (AC: 2-4)
  - [x] `components/auth/ResetPasswordRequestForm.tsx` 생성
  - [x] 이메일 입력 필드 구현
  - [x] "재설정 링크 전송" 버튼 구현
  - [x] 이메일 전송 성공 메시지 표시
  - [x] 로딩 상태 관리

- [x] Task 3: 새 비밀번호 설정 페이지 라우트 설정 (AC: 5, 6)
  - [x] `/app/auth/update-password/page.tsx` 생성
  - [x] URL hash에서 access_token 추출
  - [x] 토큰 유효성 검사

- [x] Task 4: 새 비밀번호 설정 폼 구현 (AC: 6, 7)
  - [x] `components/auth/UpdatePasswordForm.tsx` 생성
  - [x] 새 비밀번호 입력 필드 구현
  - [x] 비밀번호 확인 입력 필드 구현
  - [x] 비밀번호 표시/숨기기 토글
  - [x] 실시간 유효성 검사

- [x] Task 5: Supabase Auth 비밀번호 재설정 함수 구현 (AC: 3, 7, 8)
  - [x] `lib/auth.ts`에 `resetPassword` 함수 추가
  - [x] `lib/auth.ts`에 `updatePassword` 함수 추가
  - [x] 에러 메시지 매핑 (기존 getAuthErrorMessage 재사용)

- [x] Task 6: 이메일 템플릿 설정 (AC: 3)
  - [x] redirectTo URL을 `/auth/update-password`로 설정
  - [x] Supabase가 기본 이메일 템플릿 사용

- [x] Task 7: 에러 처리 및 사용자 피드백 (AC: 4, 8)
  - [x] 존재하지 않는 이메일 처리 (Supabase가 보안상 동일 메시지 반환)
  - [x] 만료된 링크 에러 처리 (URL hash 확인)
  - [x] 네트워크 에러 처리
  - [x] 사용자 친화적 에러 메시지 표시

- [x] Task 8: 단위 테스트 작성 (완료)
  - [x] 비밀번호 재설정 요청 테스트
  - [x] 새 비밀번호 설정 테스트
  - [x] 에러 처리 테스트
  - [x] lib/auth.ts 함수 테스트 (resetPassword, updatePassword)
  - [x] 컴포넌트 테스트 (ResetPasswordRequestForm, UpdatePasswordForm)

## 🔧 Dev Notes

### Previous Story Insights
Story 1.1 & 1.2에서 구현된 사항:
- Supabase Auth 클라이언트 설정 완료
- 이메일 유효성 검사 로직 구현
- 비밀번호 유효성 검사 로직 구현
- 인증 레이아웃 컴포넌트 구현
- 에러 메시지 매핑 함수 구현

재사용 가능한 컴포넌트 및 함수:
- `components/auth/AuthLayout.tsx` - 인증 페이지 공통 레이아웃
- `lib/validations.ts` - 이메일, 비밀번호 검증 함수
- `lib/auth.ts` - Supabase Auth 유틸리티 함수들
- `app/auth/layout.tsx` - 인증 라우트 레이아웃

### Architecture Context

**기술 스택** [Source: docs/architecture.md#1]
- Next.js App Router - 서버 컴포넌트 및 Server Actions 활용
- Supabase Auth - 비밀번호 재설정 기능
- shadcn/ui + Tailwind CSS - UI 컴포넌트
- TypeScript - 타입 안전성

**비밀번호 재설정 플로우** [Source: docs/architecture.md#3]
- Supabase Auth의 `resetPasswordForEmail` 메서드 사용
- 이메일로 재설정 링크 전송
- 링크 클릭 시 새 비밀번호 입력 페이지로 리다이렉트
- `updateUser` 메서드로 새 비밀번호 설정

**보안 고려사항** [Source: docs/architecture.md#3]
- 재설정 링크는 1시간 후 만료 (Supabase 기본값)
- 클라이언트와 서버 양측에서 유효성 검사
- 비밀번호는 Supabase에서 안전하게 해시되어 저장

### File Structure
```
app/
└── auth/
    ├── reset-password/
    │   └── page.tsx              # 새로 생성: 비밀번호 재설정 요청 페이지
    ├── update-password/
    │   └── page.tsx              # 새로 생성: 새 비밀번호 설정 페이지
    ├── login/
    │   └── page.tsx              # 기존: 로그인 페이지
    └── signup/
        └── page.tsx              # 기존: 회원가입 페이지

components/
└── auth/
    ├── ResetPasswordRequestForm.tsx  # 새로 생성: 재설정 요청 폼
    ├── UpdatePasswordForm.tsx        # 새로 생성: 새 비밀번호 설정 폼
    ├── LoginForm.tsx                 # 기존: 로그인 폼
    └── SignupForm.tsx                # 기존: 회원가입 폼

lib/
├── auth.ts                       # 업데이트: resetPassword, updatePassword 함수 추가
├── supabase.ts                   # 재사용: Supabase 클라이언트
└── validations.ts                # 재사용: 폼 유효성 검사
```

### API Specifications
- **Supabase Auth API - 재설정 요청**
  - `supabase.auth.resetPasswordForEmail(email, { redirectTo: string })`
  - 성공 시 이메일로 재설정 링크 전송
  - 실패 시 error 객체 반환

- **Supabase Auth API - 비밀번호 업데이트**
  - `supabase.auth.updateUser({ password: newPassword })`
  - 성공 시 user 객체 반환
  - 실패 시 error 객체 반환

### Testing Requirements
**테스트 파일 위치**: `__tests__/`
- `__tests__/reset-password.test.ts` - 비밀번호 재설정 테스트 (새로 생성)

**테스트 프레임워크**: Jest + Testing Library
- 재설정 요청 폼 렌더링 테스트
- 이메일 유효성 검사 테스트
- Supabase Auth 연동 모킹 테스트
- 새 비밀번호 설정 테스트
- 에러 처리 테스트

**테스트 커버리지 목표**: 100% (Statements, Branches, Functions, Lines)

### Technical Constraints
- 재설정 링크는 기본 1시간 후 만료
- 이메일은 RFC 5322 표준 준수
- 비밀번호는 최소 8자, 영문+숫자+특수문자 조합
- Supabase에서 이메일 템플릿 설정 필요

### Implementation Notes
1. `resetPasswordForEmail`의 `redirectTo` 파라미터를 `/auth/update-password`로 설정
2. Supabase Dashboard에서 이메일 템플릿의 재설정 링크 URL 확인 및 설정
3. `update-password` 페이지에서 URL hash에서 토큰 추출 (`#access_token=...`)
4. 토큰이 없거나 만료된 경우 에러 페이지로 리다이렉트
5. Story 1.1, 1.2에서 구현된 유효성 검사 함수 재사용

## 📅 Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Story 1.3 초안 생성 | Bob (Scrum Master) |

## 🔄 Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- 비밀번호 재설정 요청 페이지 및 폼 구현 완료
- 새 비밀번호 설정 페이지 및 폼 구현 완료
- Story 1.1에서 구현된 `validateEmail`, `validatePassword`, `validatePasswordMatch` 함수 재사용
- Story 1.2에서 사용된 비밀번호 표시/숨기기 토글 패턴 재사용
- `lib/auth.ts`에 `resetPassword` 및 `updatePassword` 함수 추가
- Supabase Auth의 `resetPasswordForEmail` 및 `updateUser` API 연동
- URL hash에서 access_token 추출 및 유효성 검사 로직 구현
- 만료된 링크 처리를 위한 fallback UI 구현
- 비밀번호 변경 성공 시 2초 후 로그인 페이지로 자동 리다이렉트
- 상세 디버깅 로그 추가하여 전체 플로우 추적 가능
- 보안: Supabase가 존재하지 않는 이메일에 대해서도 성공 메시지 반환 (보안 best practice)
- **단위 테스트 완료**: lib/auth.ts 함수 테스트 6개 모두 통과 (100% 커버리지)
- **컴포넌트 테스트 완료**: ResetPasswordRequestForm, UpdatePasswordForm 테스트 작성
- **테스트 시나리오**: 성공/실패/예외 처리 모든 케이스 커버

### File List
**Created:**
- `app/auth/reset-password/page.tsx` - 비밀번호 재설정 요청 페이지
- `app/auth/update-password/page.tsx` - 새 비밀번호 설정 페이지
- `components/auth/ResetPasswordRequestForm.tsx` - 재설정 요청 폼 컴포넌트
- `components/auth/UpdatePasswordForm.tsx` - 새 비밀번호 설정 폼 컴포넌트

**Modified:**
- `lib/auth.ts` - `resetPassword` 및 `updatePassword` 함수 추가

**Reused:**
- `lib/validations.ts` - `validateEmail`, `validatePassword`, `validatePasswordMatch` 함수 (Story 1.1에서 구현됨)
- `lib/auth.ts` - `getAuthErrorMessage` 함수 (Story 1.1에서 구현됨)
- `app/auth/layout.tsx` - 인증 라우트 레이아웃 (Story 1.1에서 구현됨)

**Test Files Created:**
- `__tests__/auth-functions.test.ts` - lib/auth.ts 함수 단위 테스트 (6개 테스트 통과)
- `__tests__/ResetPasswordRequestForm.test.tsx` - 재설정 요청 폼 컴포넌트 테스트
- `__tests__/UpdatePasswordForm.test.tsx` - 새 비밀번호 설정 폼 컴포넌트 테스트

## ✅ QA Results
_To be filled by QA Agent_

