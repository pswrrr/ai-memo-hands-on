# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status
Done

## Story
**As a** 사용자,
**I want** 노트 내용을 AI가 자동으로 요약해주도록 하여,
**so that** 긴 노트의 핵심 내용을 빠르게 파악할 수 있다

## Acceptance Criteria
1. 노트 내용이 3-6개 불릿 포인트로 구성된 요약으로 생성되어야 한다
2. 요약 생성 시 토큰 제한(8k 토큰)을 준수해야 한다
3. 요약 결과가 summaries 테이블에 저장되어야 한다
4. 요약 생성 중 로딩 상태가 표시되어야 한다
5. 요약 생성 실패 시 적절한 에러 처리가 되어야 한다
6. 요약 품질이 90% 이상의 정확도를 만족해야 한다

## Tasks / Subtasks
- [x] Task 1: 요약 생성 서비스 함수 구현 (AC: 1, 2)
  - [x] Subtask 1.1: Gemini API를 활용한 요약 생성 함수 구현
  - [x] Subtask 1.2: 3-6개 불릿 포인트 형식의 프롬프트 설계
  - [x] Subtask 1.3: 토큰 제한 검증 및 텍스트 자르기 로직
- [x] Task 2: 데이터베이스 연동 구현 (AC: 3)
  - [x] Subtask 2.1: summaries 테이블 스키마 확인 및 타입 정의
  - [x] Subtask 2.2: 요약 저장을 위한 Drizzle ORM 쿼리 구현
  - [x] Subtask 2.3: 기존 요약 업데이트 로직 구현
- [x] Task 3: 서버 액션 구현 (AC: 4, 5)
  - [x] Subtask 3.1: regenerateAI 서버 액션에 요약 생성 로직 추가
  - [x] Subtask 3.2: 요약 생성 중 로딩 상태 관리
  - [x] Subtask 3.3: 요약 생성 실패 시 에러 핸들링
- [x] Task 4: 프론트엔드 UI 구현 (AC: 4)
  - [x] Subtask 4.1: 요약 생성 버튼 UI 컴포넌트 구현
  - [x] Subtask 4.2: 로딩 상태 표시 컴포넌트 구현
  - [x] Subtask 4.3: 요약 결과 표시 컴포넌트 구현
- [x] Task 5: 품질 검증 및 테스트 (AC: 6)
  - [x] Subtask 5.1: 요약 품질 검증 함수 구현
  - [x] Subtask 5.2: 요약 생성 단위 테스트 작성
  - [x] Subtask 5.3: 통합 테스트 및 품질 벤치마크 테스트

## Dev Notes

### Previous Story Insights
- Story 4.1에서 Gemini API 설정 및 연동이 완료되어 API 클라이언트 사용 가능
- Epic 2의 노트 관리 시스템이 완료되어 notes 테이블과 관련 데이터 모델 준비됨
- 기존 인증 시스템(Supabase Auth)으로 사용자 스코프 관리 가능

### Data Models
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#2]
- **summaries 테이블**: note_id, model, content, created_at [Source: architecture.md#2]
- **요약 데이터 구조**: note_id (외래키), model ('gemini'), content (요약 텍스트), created_at

### API Specifications
- **Gemini API**: 4.1에서 구현된 API 클라이언트 활용 [Source: Story 4.1]
- **요약 프롬프트**: "다음 텍스트를 3-6개의 불릿 포인트로 요약해주세요: {content}"
- **토큰 제한**: 8k 토큰 제한 준수 [Source: architecture.md#6]
- **서버 액션**: regenerateAI에서 Gemini 호출 후 요약 저장 [Source: architecture.md#4]

### Component Specifications
- **요약 생성 버튼**: 노트 상세 페이지에 "AI 요약 생성" 버튼 추가
- **로딩 상태**: 스피너 또는 프로그레스 바로 처리 중 상태 표시
- **요약 표시**: 불릿 포인트 형태로 요약 결과 표시
- **에러 표시**: 요약 생성 실패 시 사용자 친화적 에러 메시지

### File Locations
- **요약 서비스**: `lib/ai/summarizer.ts` (새로 생성)
- **요약 타입**: `lib/ai/types.ts`에 SummaryResult 타입 추가
- **서버 액션**: `app/actions/notes.ts`에 generateSummary 함수 추가
- **UI 컴포넌트**: `components/notes/SummarySection.tsx` (새로 생성)
- **노트 상세 페이지**: `app/dashboard/notes/[id]/page.tsx` 수정

### Testing Requirements
- **테스트 위치**: `__tests__/ai/summarizer.test.ts` (새로 생성)
- **테스트 파일**: `__tests__/components/SummarySection.test.tsx` (새로 생성)
- **모킹**: Gemini API 응답 모킹, 데이터베이스 쿼리 모킹
- **품질 테스트**: 요약 정확도 측정을 위한 벤치마크 테스트

### Technical Constraints
- **프레임워크**: Next.js App Router, Server Actions 사용 [Source: architecture.md#1]
- **ORM**: Drizzle ORM을 통한 데이터베이스 연동 [Source: architecture.md#1]
- **보안**: 사용자 스코프로 요약 데이터 접근 제한 [Source: architecture.md#3]
- **성능**: 요약 생성 시간 10초 이내, 토큰 제한 준수 [Source: epic-4-ai-summarization-tagging.md#14]

### Quality Requirements
- **요약 정확도**: 90% 이상 (사용자 만족도 기준) [Source: epic-4-ai-summarization-tagging.md#14]
- **요약 형식**: 3-6개 불릿 포인트로 구성 [Source: epic-4-ai-summarization-tagging.md#7]
- **처리 시간**: 10초 이내 [Source: epic-4-ai-summarization-tagging.md#14]
- **에러 처리**: API 실패, 토큰 초과, 네트워크 오류 등 모든 시나리오 처리

### Testing
- **테스트 프레임워크**: Jest (기존 설정 활용)
- **테스트 위치**: `__tests__/ai/`, `__tests__/components/` 디렉토리
- **모킹 전략**: Gemini API 모킹, Supabase 클라이언트 모킹
- **테스트 범위**: 요약 생성 로직, UI 컴포넌트, 에러 핸들링, 품질 검증
- **통합 테스트**: 전체 요약 생성 플로우 테스트 (UI → 서버 액션 → API → DB)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Cursor AI Assistant)

### Debug Log References
- 요약 생성 서비스 구현: SummarizerService 클래스로 AI 요약 생성 로직 구현
- 품질 평가 시스템: 완성도, 명확성, 관련성, 구조 평가를 통한 요약 품질 측정
- UI 컴포넌트 통합: SummarySection 컴포넌트를 NoteDetail에 통합하여 사용자 경험 개선
- 포괄적인 테스트 커버리지: 61개 테스트 모두 통과로 안정성 확보

### Completion Notes List
- AI 요약 생성 서비스 구현 완료 (SummarizerService)
- 3-6개 불릿 포인트 형식의 요약 생성 및 품질 평가 시스템 구축
- 데이터베이스 연동 및 요약 저장/업데이트 로직 구현
- 서버 액션 (generateSummary, getSummary) 구현 및 에러 핸들링
- SummarySection UI 컴포넌트 구현 및 NoteDetail 통합
- 포괄적인 테스트 커버리지 (61개 테스트 모두 통과)
- 토큰 제한 관리 및 텍스트 자르기 로직 구현
- 로딩 상태 관리 및 사용자 친화적 에러 처리

### File List
- **생성된 파일**:
  - `lib/ai/summarizer.ts` - AI 요약 생성 서비스
  - `components/notes/SummarySection.tsx` - 요약 섹션 UI 컴포넌트
  - `__tests__/ai/summarizer.test.ts` - 요약 서비스 테스트
  - `__tests__/components/SummarySection.test.tsx` - UI 컴포넌트 테스트
  - `__tests__/ai/generate-summary.test.ts` - 서버 액션 테스트
- **수정된 파일**:
  - `lib/ai/types.ts` - 요약 관련 타입 정의 추가
  - `lib/db/supabase-db.ts` - 요약 저장/업데이트 메서드 추가
  - `app/actions/notes.ts` - generateSummary, getSummary 서버 액션 추가
  - `components/notes/NoteDetail.tsx` - SummarySection 컴포넌트 통합

## QA Results
*QA 에이전트가 검토 시 기록*
