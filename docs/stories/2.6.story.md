# Story 2.6: 노트 삭제 및 복구

## Status
Done

## Story
**As a** 사용자,
**I want** 불필요한 노트를 삭제하고 실수로 삭제한 노트를 복구할 수 있도록,
**so that** 노트를 안전하게 관리할 수 있다

## Acceptance Criteria
1. 사용자는 노트 상세 페이지에서 삭제 버튼을 클릭하여 노트를 삭제할 수 있다
2. 삭제 전 확인 다이얼로그가 표시된다
3. 삭제된 노트는 즉시 목록에서 사라진다
4. 삭제된 노트는 30일간 휴지통에 보관된다
5. 휴지통에서 삭제된 노트를 복구할 수 있다
6. 휴지통에서 영구 삭제할 수 있다
7. 다른 사용자의 노트는 삭제할 수 없다
8. 삭제/복구 작업 후 적절한 피드백 메시지가 표시된다
9. 로딩 상태가 표시된다
10. 에러 발생 시 사용자에게 적절한 메시지가 표시된다

## Tasks / Subtasks
- [x] 노트 삭제 서버 액션 구현 (AC: 1, 3, 4, 7)
  - [x] deleteNote 서버 액션 생성
  - [x] 사용자 권한 검증
  - [x] 소프트 삭제 로직 구현
  - [x] deletedAt 필드 추가
- [x] 노트 복구 서버 액션 구현 (AC: 5, 7)
  - [x] restoreNote 서버 액션 생성
  - [x] 권한 검증
  - [x] 복구 로직 구현
- [x] 영구 삭제 서버 액션 구현 (AC: 6, 7)
  - [x] permanentDeleteNote 서버 액션 생성
  - [x] 권한 검증
  - [x] 영구 삭제 로직 구현
- [x] 삭제 확인 다이얼로그 구현 (AC: 2, 8, 9, 10)
  - [x] DeleteConfirmDialog 컴포넌트 생성
  - [x] 확인/취소 버튼 구현
  - [x] 로딩/에러 상태 처리
- [x] 휴지통 UI 구현 (AC: 4, 5, 6)
  - [x] TrashPage 컴포넌트 생성
  - [x] 삭제된 노트 목록 표시
  - [x] 복구/영구삭제 버튼 구현
- [x] 데이터베이스 스키마 업데이트 (AC: 4)
  - [x] notes 테이블에 deletedAt 필드 추가
  - [x] 마이그레이션 생성
- [x] 테스트 구현 (AC: 1-10)
  - [x] 서버 액션 테스트
  - [x] 컴포넌트 테스트
  - [x] 권한 검증 테스트
  - [x] 휴지통 로직 테스트

## Dev Notes

### Relevant Source Tree Info
- `app/dashboard/trash/page.tsx` - 휴지통 페이지
- `app/actions/notes.ts` - 노트 관련 서버 액션
- `lib/db/schema.ts` - 데이터베이스 스키마
- `components/notes/` - 노트 관련 컴포넌트들
- `components/ui/` - shadcn/ui 컴포넌트들

### Testing
- **Test file location**: `__tests__/`
- **Test standards**: Jest + Testing Library 사용
- **Testing frameworks**: 
  - Unit tests: Jest
  - Component tests: @testing-library/react
  - Integration tests: Jest
- **Specific testing requirements**:
  - 소프트 삭제 로직 테스트
  - 휴지통 복구 로직 테스트
  - 권한 검증 테스트
  - 삭제 확인 다이얼로그 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-14 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- 테스트 실행 결과: DeleteConfirmDialog 컴포넌트 테스트 6개 모두 통과
- TextEncoder 폴리필 추가로 Jest 환경 문제 해결
- sonner 패키지 추가로 toast 기능 구현

### Completion Notes List
1. **데이터베이스 스키마 업데이트**
   - notes 테이블에 deletedAt 필드 추가 (nullable timestamp)
   - 마이그레이션 파일 생성 및 적용
   - 소프트 삭제 방식으로 구현하여 30일간 복구 가능

2. **서버 액션 구현**
   - deleteNote: 노트 소프트 삭제 (deletedAt 필드 설정)
   - restoreNote: 노트 복구 (deletedAt을 null로 설정)
   - permanentDeleteNote: 노트 영구 삭제 (DB에서 완전 제거)
   - getTrashNotes: 휴지통 노트 목록 조회 (페이지네이션 지원)
   - 모든 액션에 인증 및 권한 검증 로직 포함

3. **UI 컴포넌트 구현**
   - DeleteConfirmDialog: 삭제 확인 다이얼로그 (경고 메시지, 로딩 상태)
   - PermanentDeleteDialog: 영구 삭제 확인 다이얼로그
   - TrashContent: 휴지통 페이지 메인 컴포넌트
   - TrashNoteCard: 삭제된 노트 카드 (복구/영구삭제 버튼)
   - TrashLoading: 로딩 스켈레톤 UI

4. **기존 컴포넌트 수정**
   - NoteDetail: 삭제 버튼에 다이얼로그 연결
   - DashboardPage: 휴지통 링크 추가
   - getNotes 액션: 삭제되지 않은 노트만 조회하도록 필터링

5. **테스트 구현**
   - DeleteConfirmDialog 컴포넌트 테스트 (6개 테스트 케이스)
   - 서버 액션 테스트 파일 생성 (delete, restore, permanent-delete)
   - Jest 설정 개선 (TextEncoder, TextDecoder 폴리필)

6. **사용자 경험 개선**
   - toast 알림으로 작업 결과 피드백
   - 로딩 상태 표시
   - 에러 메시지 표시
   - 30일 후 자동 삭제 안내 메시지
   - 영구 삭제 경고 메시지

### File List
**새로 생성된 파일:**
- `app/dashboard/trash/page.tsx` - 휴지통 페이지
- `components/trash/TrashContent.tsx` - 휴지통 메인 컴포넌트
- `components/trash/TrashNoteCard.tsx` - 삭제된 노트 카드
- `components/trash/TrashLoading.tsx` - 로딩 스켈레톤
- `components/trash/PermanentDeleteDialog.tsx` - 영구 삭제 확인 다이얼로그
- `components/notes/DeleteConfirmDialog.tsx` - 삭제 확인 다이얼로그
- `components/ui/dialog.tsx` - Shadcn Dialog 컴포넌트
- `lib/db/migrations/0002_daily_colonel_america.sql` - deletedAt 필드 마이그레이션
- `__tests__/delete-note.test.ts` - 노트 삭제 액션 테스트
- `__tests__/restore-note.test.ts` - 노트 복구 액션 테스트
- `__tests__/permanent-delete-note.test.ts` - 영구 삭제 액션 테스트
- `__tests__/DeleteConfirmDialog.test.tsx` - 삭제 다이얼로그 컴포넌트 테스트

**수정된 파일:**
- `lib/db/schema.ts` - notes 테이블에 deletedAt 필드 추가
- `app/actions/notes.ts` - 삭제/복구/영구삭제/휴지통 조회 액션 추가, getNotes 필터링 수정
- `components/notes/NoteDetail.tsx` - 삭제 버튼에 다이얼로그 연결
- `app/dashboard/page.tsx` - 휴지통 링크 추가
- `jest.setup.js` - TextEncoder/TextDecoder 폴리필 추가
- `jest.config.js` - 테스트 환경 옵션 추가
- `package.json` - sonner 패키지 추가

## QA Results
*Results from QA Agent review will be added here*
