# Story 4.1: Gemini API 설정 및 연동

## Status
Done

## Story
**As a** 개발자,
**I want** Google Gemini API를 프로젝트에 설정하고 연동하도록 하여,
**so that** AI 기반 요약 및 태깅 기능의 기반을 구축할 수 있다

## Acceptance Criteria
1. Google Gemini API 키가 환경변수로 안전하게 설정되어야 한다
2. Gemini API 클라이언트가 초기화되고 연결이 검증되어야 한다
3. API 호출을 위한 기본 서비스 함수가 구현되어야 한다
4. 토큰 제한(8k 토큰) 관리 기능이 포함되어야 한다
5. API 에러 핸들링 및 재시도 로직이 구현되어야 한다
6. API 호출 테스트가 작성되어야 한다

## Tasks / Subtasks
- [x] Task 1: 환경 설정 및 API 키 관리 (AC: 1)
  - [x] Subtask 1.1: 환경변수에 GEMINI_API_KEY 추가
  - [x] Subtask 1.2: API 키 유효성 검증 함수 구현
  - [x] Subtask 1.3: 환경변수 로딩 및 에러 핸들링
- [x] Task 2: Gemini API 클라이언트 설정 (AC: 2)
  - [x] Subtask 2.1: Google AI SDK 설치 및 설정
  - [x] Subtask 2.2: Gemini API 클라이언트 초기화
  - [x] Subtask 2.3: API 연결 테스트 함수 구현
- [x] Task 3: 기본 API 서비스 함수 구현 (AC: 3)
  - [x] Subtask 3.1: generateContent 메서드 래퍼 함수 생성
  - [x] Subtask 3.2: 요청/응답 타입 정의
  - [x] Subtask 3.3: API 응답 파싱 및 검증 로직
- [x] Task 4: 토큰 제한 관리 구현 (AC: 4)
  - [x] Subtask 4.1: 텍스트 토큰 계산 함수 구현
  - [x] Subtask 4.2: 8k 토큰 제한 검증 로직
  - [x] Subtask 4.3: 토큰 초과 시 텍스트 자르기 기능
- [x] Task 5: 에러 핸들링 및 재시도 로직 (AC: 5)
  - [x] Subtask 5.1: API 에러 타입 정의
  - [x] Subtask 5.2: 재시도 로직 구현 (최대 3회)
  - [x] Subtask 5.3: 에러 로깅 및 사용자 친화적 메시지
- [x] Task 6: 테스트 작성 (AC: 6)
  - [x] Subtask 6.1: API 클라이언트 초기화 테스트
  - [x] Subtask 6.2: 토큰 계산 함수 단위 테스트
  - [x] Subtask 6.3: 에러 핸들링 시나리오 테스트
  - [x] Subtask 6.4: API 호출 모킹 테스트

## Dev Notes

### Previous Story Insights
- Epic 2의 노트 관리 시스템이 완료되어 notes 테이블과 관련 데이터 모델이 준비됨
- 기존 인증 시스템(Supabase Auth)이 구축되어 사용자 스코프 관리 가능

### Data Models
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#2]
- **summaries 테이블**: note_id, model, content, created_at [Source: architecture.md#2]
- **note_tags 테이블**: note_id, tag [Source: architecture.md#2]

### API Specifications
- **Google Gemini API**: 요약/태깅을 위한 AI 모델 [Source: architecture.md#1]
- **토큰 제한**: 8k 토큰 제한 관리 필요 [Source: architecture.md#6]
- **서버 액션**: regenerateAI 서버 액션에서 Gemini 호출 후 요약/태그 저장 [Source: architecture.md#4]

### Component Specifications
- **서버 사이드 처리**: API 호출은 서버 액션에서 처리 [Source: architecture.md#4]
- **환경변수 관리**: Supabase 서비스 롤 키와 동일한 방식으로 관리 [Source: architecture.md#3]

### File Locations
- **API 서비스**: `lib/ai/gemini.ts` (새로 생성)
- **타입 정의**: `lib/ai/types.ts` (새로 생성)
- **환경변수**: `.env.local`에 GEMINI_API_KEY 추가
- **서버 액션**: `app/actions/notes.ts`에 regenerateAI 함수 추가

### Testing Requirements
- **테스트 위치**: `__tests__/ai/` 디렉토리 (새로 생성)
- **테스트 파일**: `gemini-api.test.ts`, `token-calculator.test.ts`
- **모킹**: Google AI SDK 모킹을 통한 API 호출 테스트
- **환경변수 테스트**: API 키 누락 시 에러 처리 테스트

### Technical Constraints
- **프레임워크**: Next.js App Router, Server Actions 사용 [Source: architecture.md#1]
- **ORM**: Drizzle ORM을 통한 데이터베이스 연동 [Source: architecture.md#1]
- **보안**: API 키는 서버 전용, 클라이언트 노출 금지 [Source: architecture.md#3]
- **성능**: 요약 길이 제한으로 성능 가드레일 준수 [Source: architecture.md#6]
- **패키지**: `@google/genai` 패키지 사용 (최신 Google AI SDK)

### Testing
- **테스트 프레임워크**: Jest (기존 설정 활용)
- **테스트 위치**: `__tests__/ai/` 디렉토리
- **모킹 전략**: Google AI SDK 모킹, 환경변수 모킹
- **테스트 범위**: API 클라이언트 초기화, 토큰 계산, 에러 핸들링, 재시도 로직
- **통합 테스트**: 실제 API 호출 없이 모킹된 환경에서 전체 플로우 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Cursor AI Assistant)

### Debug Log References
- 토큰 계산 로직 개선: truncateText 메서드에서 더 정확한 토큰 제한 적용
- Jest 테스트 환경 설정: Next.js 관련 폴리필 추가로 테스트 환경 개선
- revalidatePath 모킹: 테스트 환경에서 Next.js 캐시 함수 모킹 처리

### Completion Notes List
- `@google/genai` 패키지 설치 및 Gemini API 클라이언트 구현 완료
- 토큰 제한 관리 (8k 토큰) 및 텍스트 자르기 기능 구현
- 재시도 로직 (최대 3회) 및 에러 핸들링 구현
- 포괄적인 테스트 커버리지 (38개 테스트 모두 통과)
- 서버 액션에 regenerateAI 함수 추가
- 데이터베이스에 summaries, note_tags 관련 메서드 추가
- `@google/generative-ai`에서 `@google/genai`로 패키지 마이그레이션 완료

### File List
- **생성된 파일**:
  - `lib/ai/types.ts` - AI 관련 타입 정의
  - `lib/ai/gemini.ts` - Gemini API 클라이언트 및 서비스 함수
  - `__tests__/ai/gemini-api.test.ts` - Gemini API 클라이언트 테스트
  - `__tests__/ai/token-calculator.test.ts` - 토큰 계산 함수 테스트
  - `__tests__/ai/regenerate-ai.test.ts` - regenerateAI 서버 액션 테스트
- **수정된 파일**:
  - `app/actions/notes.ts` - regenerateAI 서버 액션 추가
  - `lib/db/supabase-db.ts` - summaries, note_tags 관련 메서드 추가
  - `jest.setup.js` - Next.js 관련 폴리필 추가
  - `package.json` - @google/generative-ai 의존성 추가

## QA Results
*QA 에이전트가 검토 시 기록*
